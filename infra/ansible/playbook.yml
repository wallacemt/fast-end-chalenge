- hosts: all
  become: true
  roles:
    - docker
  tasks:
    - name: Restart Docker service
      systemd:
        name: docker
        state: restarted
        enabled: yes

    - name: Wait for Docker to be ready
      wait_for:
        port: 2376
        host: localhost
        timeout: 30
      ignore_errors: yes

- hosts: managers
  become: true
  roles:
    - swarm

- hosts: workers
  become: true
  tasks:
    - name: Check if node is already in swarm
      command: docker info --format '{{.Swarm.LocalNodeState}}'
      register: swarm_status
      ignore_errors: yes

    - name: Join Docker Swarm as worker
      community.docker.docker_swarm:
        state: join
        join_token: "{{ swarm_worker_token }}"
        remote_addrs:
          - "{{ swarm_manager_ip }}:2377"
      when:
        - swarm_worker_token is defined
        - swarm_status.stdout != "active"

- hosts: managers
  become: true
  roles:
    - deploy_stack
