- hosts: all
  become: true
  roles:
    - docker
  tasks:
    - name: Restart Docker service
      systemd:
        name: docker
        state: restarted
        enabled: yes

    - name: Wait for Docker daemon to be ready
      shell: docker info
      register: docker_info
      until: docker_info.rc == 0
      retries: 10
      delay: 3
      ignore_errors: yes

- hosts: managers
  become: true
  roles:
    - swarm

- hosts: workers
  become: true
  tasks:
    - name: Get swarm info from dummy host
      set_fact:
        swarm_worker_token: "{{ hostvars['swarm_info']['swarm_worker_token'] | default('') }}"
        swarm_manager_ip: "{{ hostvars['swarm_info']['swarm_manager_ip'] | default('') }}"

    - name: Debug swarm variables
      debug:
        msg:
          - "Worker token defined: {{ swarm_worker_token is defined }}"
          - "Manager IP defined: {{ swarm_manager_ip is defined }}"
          - "Token value: {{ swarm_worker_token | default('UNDEFINED') }}"
          - "Manager IP: {{ swarm_manager_ip | default('UNDEFINED') }}"

    - name: Join Docker Swarm as worker (always attempt)
      community.docker.docker_swarm:
        state: join
        join_token: "{{ swarm_worker_token }}"
        remote_addrs:
          - "{{ swarm_manager_ip }}:2377"
      when:
        - swarm_worker_token is defined
        - swarm_manager_ip is defined
        - swarm_worker_token != ""
        - swarm_manager_ip != ""
      register: join_result
      ignore_errors: yes

    - name: Display join result
      debug:
        msg:
          - "Join attempt result: {{ 'Success' if join_result.changed else 'Already in swarm or failed' }}"
          - "Error (if any): {{ join_result.msg | default('No error') }}"

- hosts: managers
  become: true
  roles:
    - deploy_stack
