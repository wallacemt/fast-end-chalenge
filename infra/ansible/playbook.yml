---
- hosts: all
  gather_facts: no  # â† Desabilita gathering automÃ¡tico
  tasks:
    - name: ğŸ” Test basic connectivity
      ping:

    - name: ğŸ Check Python version
      raw: python3 --version
      register: python_check
      ignore_errors: yes

    - name: ğŸ“¦ Install Python3 if missing
      raw: sudo apt update && sudo apt install -y python3 python3-pip
      when: python_check is failed
      ignore_errors: yes

    - name: ğŸ”§ Gather facts manually with retries
      setup:
      register: setup_result
      until: setup_result is succeeded
      retries: 3
      delay: 5
      ignore_errors: yes

    - name: âš ï¸ Show warning if facts gathering failed
      debug:
        msg: "WARNING: Could not gather facts, proceeding anyway..."
      when: setup_result is failed

- hosts: all
  become: true
  gather_facts: no  # â† JÃ¡ coletamos manualmente
  roles:
    - docker
  tasks:
    - name: ğŸ”„ Restart Docker service
      systemd:
        name: docker
        state: restarted
        enabled: yes

    - name: â³ Wait for Docker daemon to be ready
      shell: docker info
      register: docker_info
      until: docker_info.rc == 0
      retries: 10
      delay: 3
      ignore_errors: yes

# Single play for swarm setup to avoid delegation issues
- hosts: all
  become: true
  gather_facts: no
  serial: 1
  tasks:
    # Manager tasks
    - name: ğŸ” Check if swarm is already initialized
      shell: docker info | grep "Swarm:" | awk '{print $2}'
      register: swarm_status
      ignore_errors: yes
      when: inventory_hostname in groups['managers']

    - name: ğŸš€ Initialize Docker Swarm if not active
      community.docker.docker_swarm:
        state: present
        advertise_addr: "{{ ansible_host }}"
      register: swarm_init
      when:
        - inventory_hostname in groups['managers']
        - swarm_status.stdout != "active"

    - name: ğŸ”‘ Get join token for workers
      shell: docker swarm join-token -q worker
      register: worker_token
      when: inventory_hostname in groups['managers']

    - name: ğŸ“‹ Set manager facts globally
      set_fact:
        swarm_worker_token: "{{ hostvars[groups['managers'][0]]['worker_token']['stdout'] }}"
        swarm_manager_ip: "{{ hostvars[groups['managers'][0]]['ansible_host'] }}"
      when: inventory_hostname in groups['workers']

    - name: ğŸ› Debug token info for workers
      debug:
        msg:
          - "Manager IP: {{ swarm_manager_ip | default('NOT_SET') }}"
          - "Worker Token: {{ swarm_worker_token | default('NOT_SET') }}"
          - "Current host: {{ inventory_hostname }}"
          - "Is worker: {{ inventory_hostname in groups['workers'] }}"
      when: inventory_hostname in groups['workers']

    - name: ğŸ” Check current swarm status on workers
      shell: docker info | grep "Swarm:" | awk '{print $2}'
      register: current_swarm_status
      ignore_errors: yes
      when: inventory_hostname in groups['workers']

    - name: ğŸ¤ Join swarm as worker
      community.docker.docker_swarm:
        state: join
        join_token: "{{ swarm_worker_token }}"
        remote_addrs:
          - "{{ swarm_manager_ip }}:2377"
      register: join_result
      ignore_errors: yes
      when:
        - inventory_hostname in groups['workers']
        - swarm_worker_token is defined
        - swarm_worker_token != ""
        - swarm_manager_ip is defined
        - swarm_manager_ip != ""
        - current_swarm_status.stdout != "active"

    - name: ğŸ“Š Display join result for workers
      debug:
        msg:
          - "Current swarm status: {{ current_swarm_status.stdout | default('unknown') }}"
          - "Join attempted: {{ join_result.changed | default(false) }}"
          - "Join error: {{ join_result.msg | default('No error or not attempted') }}"
      when: inventory_hostname in groups['workers']

# Final verification and deployment
- hosts: managers
  become: true
  gather_facts: no
  tasks:
    - name: â³ Wait for workers to join
      pause:
        seconds: 10

    - name: âœ… Verify swarm cluster
      shell: docker node ls
      register: swarm_nodes

    - name: ğŸ“‹ Display swarm cluster status
      debug:
        msg: "{{ swarm_nodes.stdout_lines }}"

    - name: ğŸš€ Deploy application stack
      include_role:
        name: deploy_stack