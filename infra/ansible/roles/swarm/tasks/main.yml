- name: Install pip3
  package:
    name: python3-pip
    state: present

- name: Install Docker SDK for Python
  pip:
    name: docker>=5.0.0
    state: present

- name: Initialize Docker Swarm (if not already)
  community.docker.docker_swarm:
    state: present
    advertise_addr: "{{ ansible_host }}"
  register: swarm_init

- name: Get join token for workers
  command: docker swarm join-token -q worker
  when: swarm_init is changed or swarm_init is succeeded
  register: worker_token

- name: Set worker token fact globally
  set_fact:
    swarm_worker_token: "{{ worker_token.stdout }}"
    swarm_manager_ip: "{{ ansible_host }}"
  delegate_to: "{{ item }}"
  delegate_facts: true
  with_items: "{{ groups['all'] }}"
  when: worker_token is defined and worker_token.stdout is defined
